<div class="todos-container">
  <div class="todos-header">
    <div class="header-content">
      <h2>Mes Todos</h2>
    </div>
  </div>

  <!-- Dashboard des statistiques -->
  <div class="dashboard-stats">
    <h2 class="stats-title">Statistiques en temps réel</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <h3 class="stat-label">Total</h3>
        <p class="stat-value total">{{ todoService.todoStats().total }}</p>
      </div>
      <div class="stat-card">
        <h3 class="stat-label">Complétés</h3>
        <p class="stat-value completed">{{ todoService.todoStats().completed }}</p>
      </div>
      <div class="stat-card">
        <h3 class="stat-label">En cours</h3>
        <p class="stat-value in-progress">{{ todoService.todoStats().inProgress }}</p>
      </div>
      <div class="stat-card">
        <h3 class="stat-label">Priorité haute</h3>
        <p class="stat-value high-priority">{{ todoService.todoStats().highPriority }}</p>
      </div>
      <div class="stat-card">
        <h3 class="stat-label">Taux de complétion</h3>
        <p class="stat-value completion-rate">
          {{ todoService.todoStats().completionRate | number: '1.0-0' }}%
        </p>
      </div>
    </div>
  </div>

  @if (loading()) {
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Chargement des todos...</p>
    </div>
  } @else {
    <div class="add-todo-form">
      <h3>Ajouter une tâche</h3>
      <form (ngSubmit)="addTodo()" #todoForm="ngForm">
        <div class="form-grid">
          <input
            type="text"
            [(ngModel)]="newTodo.title"
            name="title"
            placeholder="Titre de la tâche"
            required
          />

          <input
            type="text"
            [(ngModel)]="newTodo.description"
            name="description"
            placeholder="Description (optionnel)"
          />

          <input
            type="number"
            [(ngModel)]="newTodo.duration"
            name="duration"
            placeholder="Durée estimée (minutes)"
            min="1"
          />
        </div>

        <div class="form-row">
          <select [(ngModel)]="newTodo.priority" name="priority">
            <option value="low">Basse priorité</option>
            <option value="medium">Priorité moyenne</option>
            <option value="high">Haute priorité</option>
          </select>

          <button
            type="submit"
            class="add-button"
            [disabled]="!todoForm.form.valid || addingTodo()"
          >
            @if (addingTodo()) {
              <span class="spinner"></span>
            }
            Ajouter
          </button>
        </div>
      </form>
    </div>

    <div class="kanban-board">
      <div class="kanban-column todo-column">
        <h3>
          À faire
          <span class="count">({{ getTodosByStatus('todo').length }})</span>
        </h3>
        @for (todo of getTodosByStatus('todo'); track trackByTodoId) {
          <div
            class="todo-item"
            [appHighlight]="todo.priority === 'high' ? 'rgba(239, 68, 68, 0.1)' : 'transparent'"
            [appHighlightDelay]="todo.priority === 'high' ? 500 : 0"
          >
            <h4>{{ todo.title }}</h4>
            @if (todo.description) {
              <p>{{ todo.description }}</p>
            }
            <div class="todo-footer">
              <div class="todo-info">
                <span class="priority-badge" [class]="todo.priority">
                  {{ todo.priority | priority }}
                </span>
                @if (todo.duration) {
                  <span class="duration-badge">
                    {{ todo.duration | duration }}
                  </span>
                }
              </div>
              <button (click)="updateStatus(todo.id, 'in-progress')" class="action-button">
                Commencer
              </button>
            </div>
          </div>
        }
      </div>

      <div class="kanban-column in-progress-column">
        <h3>
          En cours
          <span class="count">({{ getTodosByStatus('in-progress').length }})</span>
        </h3>
        @for (todo of getTodosByStatus('in-progress'); track trackByTodoId) {
          <div
            class="todo-item"
            [appHighlight]="todo.priority === 'high' ? 'rgba(239, 68, 68, 0.1)' : 'transparent'"
            [appHighlightDelay]="todo.priority === 'high' ? 500 : 0"
          >
            <h4>{{ todo.title }}</h4>
            @if (todo.description) {
              <p>{{ todo.description }}</p>
            }
            <div class="todo-footer">
              <div class="todo-info">
                <span class="priority-badge" [class]="todo.priority">
                  {{ todo.priority | priority }}
                </span>
                @if (todo.duration) {
                  <span class="duration-badge">
                    {{ todo.duration | duration }}
                  </span>
                }
              </div>
              <button (click)="updateStatus(todo.id, 'done')" class="action-button">
                Terminer
              </button>
            </div>
          </div>
        }
      </div>

      <div class="kanban-column done-column">
        <h3>
          Terminé
          <span class="count">({{ getTodosByStatus('done').length }})</span>
        </h3>
        @for (todo of getTodosByStatus('done'); track trackByTodoId) {
          <div
            class="todo-item"
            [appHighlight]="todo.priority === 'high' ? 'rgba(34, 197, 94, 0.1)' : 'transparent'"
            [appHighlightDelay]="todo.priority === 'high' ? 500 : 0"
          >
            <h4>{{ todo.title }}</h4>
            @if (todo.description) {
              <p>{{ todo.description }}</p>
            }
            <div class="todo-footer">
              <div class="todo-info">
                <span class="priority-badge" [class]="todo.priority">
                  {{ todo.priority | priority }}
                </span>
                @if (todo.duration) {
                  <span class="duration-badge">
                    {{ todo.duration | duration }}
                  </span>
                }
              </div>
              <button (click)="deleteTodo(todo.id)" class="action-button delete">Supprimer</button>
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>
